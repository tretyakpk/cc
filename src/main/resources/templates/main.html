<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Pure Bros Customer care service</title>

    <link th:href="@{/assets/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/font-awesome/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/assets/css/animate.css}" rel="stylesheet">
    <link th:href="@{/assets/css/style.css}" rel="stylesheet">

    <!-- sweet alert -->
    <link th:href="@{/assets/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">

    <!-- custom css -->
    <link th:href="@{/assets/css/custom/custom.css}" rel="stylesheet">

    <!-- footable css -->
    <link th:href="@{/assets/css/plugins/footable/footable.core.css}" rel="stylesheet">
</head>

<body class="top-navigation pace-done">
<div id="wrapper">
    <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom white-bg">
            <nav class="navbar navbar-static-top" role="navigation">
                <div class="navbar-header">
                    <button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" class="navbar-toggle collapsed" type="button">
                        <i class="fa fa-reorder"></i>
                    </button>
                    <span class="navbar-brand custom-bg">PureBros Customer care</span>
                </div>
                <div class="navbar-collapse collapse custom-bg" id="navbar">
                    <ul class="nav navbar-top-links navbar-right">
                        <li style="font-size: 14px;">
                            <span sec:authentication="name">Username</span>
                        </li>
                        <li>
                            <a th:href="@{/logout}" class="custom-bg">
                                <i class="fa fa-sign-out"></i> Log out
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="wrapper wrapper-content">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-md-4 col-sm-4">
                                        <input id="msisdn-input" class="form-control custom-search-field" type="text"  placeholder="MSISDN">
                                    </div>
                                    <div class="col-md-2 col-sm-2">
                                        <select id="carrier-select" class="form-control custom-select-field">
                                            <option th:value="voda">VODAFONE</option>
                                            <option th:value="wind">WIND</option>
                                            <option th:value="tim">TIM</option>
                                            <option th:value="h3g">H3G</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1 col-sm-2">
                                        <a class="search btn custom-bg" id="find-subscriptions">Search</a>
                                    </div>
                                    <div class="col-md-1 col-sm-2">
                                        <button class="btn custom-bg" id="history">History</button>
                                    </div>
                                </div>
                            </div>
                            <div id="subscriptions" class="ibox-content" >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div>
                <strong>Copyright:</strong> Pure Bros Mobile 2018
            </div>
        </div>

    </div>

    <!-- mainly scripts -->
    <script th:src="@{/assets/js/jquery-3.1.1.min.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <script th:src="@{/assets/js/plugins/metisMenu/jquery.metisMenu.js}"></script>
    <script th:src="@{/assets/js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>

    <!-- sweet alert -->
    <script th:src="@{/assets/js/plugins/sweetalert/sweetalert.min.js}"></script>

    <!-- fooTable -->
    <script th:src="@{/assets/js/plugins/footable/footable.all.min.js}"></script>

    <!-- custom inspinia and plugin javascript -->
    <script th:src="@{/assets/js/inspinia.js}"></script>
    <script th:src="@{/assets/js/plugins/pace/pace.min.js}"></script>

    <!-- page-level scripts -->
    <script>

        $(document).ready(function() {



            /**
             * Function to build main subscription table
             */
            function showSubscriptionsTable() {
                var parentTable = $('#subscriptions');
                parentTable.find('#subscriptions-filter').remove();
                parentTable.find('table').remove();
                parentTable.append(
                    '<input type="text" class="form-control input-sm m-b-xs custom-search-field" id="subscriptions-filter" placeholder="Search in table">' +
                    '<table id="subscriptions-table" class="table table-hover table-stripped toggle-arrow-tiny text-center" data-page-size="5" data-filter=#subscriptions-filter >' +
                        '<thead >' +
                            '<tr>' +
                                '<th class="text-center" data-sort-ignore="true">MSISDN</th>' +
                                '<th class="text-center" data-sort-ignore="true">CARRIER</th>' +
                                '<th class="text-center">ACCOUNT</th>' +
                                '<th class="text-center">CSP</th>' +
                                '<th class="text-center">SERVICE</th>' +
                                '<th class="text-center">SUBSCRIBED FROM</th>' +
                                '<th class="text-center">SUBSCRIBED TO</th>' +
                                '<th class="text-center" data-sort-ignore="true">STATUS</th>' +
                                '<th class="text-center" data-sort-ignore="true"></th>' +
                                '<th class="text-center" data-sort-ignore="true"></th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                        '</tbody>' +
                        '<tfoot>' +
                            '<tr>' +
                                '<td colspan="9">' +
                                    '<ul class="pagination pull-right"></ul>' +
                                '</td>' +
                            '</tr>' +
                        '</tfoot>' +
                    '</table>');
            }

            /**
             * Find all subscriptions and write data to the table
             */
            $("#find-subscriptions").click( function () {
                var msisdn  = $('#msisdn-input').val();
                var carrier = $('#carrier-select').find('option:selected').val();
                swal({
                    title: "Loading...",
                    text: "Please wait",
                    imageUrl: "/assets/img/processing.gif",
                    showConfirmButton: false,
                    allowOutsideClick: false
                });
                $.post('/subscriptions', {
                        "msisdn": msisdn,
                        "carrier": carrier
                    }, function (returnedData) {
                        console.log('Successfully received: ' + returnedData.length + ' subscriptions');
                        if(returnedData && returnedData.length !== 0) {
                            swal ( {
                                title: "OK!",
                                text: "Successfully found: " + returnedData.length + " subscriptions",
                                type: "success",
                                confirmButtonColor: "#3e9c76",
                                confirmButtonText: "OK",
                                closeOnConfirm: true,
                                closeOnCancel: true,
                                allowOutsideClick: true
                            });
                            showSubscriptionsTable();
                            var subscriptionsTable = $('#subscriptions-table');
                            for(var i = 0; i < returnedData.length; i++){
                                subscriptionsTable.find('tbody').append('<tr>' +
                                    '<td>' + msisdn + '</td>' +
                                    '<td>' + carrier + '</td>' +
                                    '<td>' + returnedData[i]['account'] + '</td>' +
                                    '<td>' + returnedData[i]['providerName'] + '</td>' +
                                    '<td>' + returnedData[i]['serviceName'] + '</td>' +
                                    '<td>' + returnedData[i]['subscriptionStart'] + '</td>' +
                                    '<td>' + (returnedData[i]['subscriptionEnd'] ? returnedData[i]['subscriptionEnd'] : '') + '</td>' +
                                    '<td>' + (returnedData[i]['active'] ? '<i class="fa fa-check text-navy">' : '<i class="fa fa-times-circle text-danger "></i>')  + '</td>' +
                                    '<td>' + (returnedData[i]['active'] ? '<button value="' + returnedData[i]['unsubscriptionUrl'] +'" class="subscription-deactivate btn btn-sm btn-danger custom-buttom-margin">Deactivate</button>' : '') + '</td>' +
                                    '</tr>');
                            }
                        } else if(returnedData && returnedData.length > 0) {
                            swal ( {
                                title: "Oops...",
                                text: "Not found subscriptions!",
                                type: "warning",
                                confirmButtonColor: "#3e9c76",
                                confirmButtonText: "OK",
                                closeOnConfirm: true,
                                closeOnCancel: true
                            });
                        }
                        else {
                            swal ( {
                                title: "Oops...",
                                text: "Something went wrong!",
                                type: "error",
                                confirmButtonColor: "#3e9c76",
                                confirmButtonText: "OK",
                                closeOnConfirm: true,
                                closeOnCancel: true
                            });
                        }
                        subscriptionsTable.footable();
                        addListeners();
                    }, 'json');
            });

            function addListeners(){
                $('.subscription-deactivate').click( function( e ){
                    e.preventDefault();
                    var deactivationLink = this.getAttribute("value");
                    swal ( {
                            title: "Are you sure?",
                            type: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#f45a54",
                            cancelButtonColor: "#6e6e70",
                            confirmButtonText: "Yes, deactivate",
                            cancelButtonText: "No, cancel plz",
                            closeOnConfirm: false,
                            closeOnCancel: false,
                            allowOutsideClick: false
                        },
                        function ( isConfirm ) {
                            swal({
                                title: "Loading...",
                                text: "Please wait",
                                imageUrl: "/assets/img/processing.gif",
                                showConfirmButton: false,
                                allowOutsideClick: false
                            });
                            if ( isConfirm ) {
                                console.log('Confirm subscription deactivation');
                                $.ajax ( {
                                    type: "POST",
                                    url: "/subscriptions/deactivate",
                                    data: {
                                        link: deactivationLink
                                    },
                                    success: function ( result ) {
                                        swal ( {
                                            title: "OK!",
                                            text: result,
                                            type: "success",
                                            confirmButtonColor: "#3e9c76",
                                            confirmButtonText: "OK",
                                            closeOnConfirm: true,
                                            closeOnCancel: true,
                                            allowOutsideClick: true
                                        });
                                        this.attr("disabled", true);
                                        console.log(result);
                                        // TODO: set deactivation timestamp and status not active
                                    },
                                    error: function ( result ) {
                                        swal ( {
                                            title: "Subscription has not been successfully deactivated!",
                                            type: "error",
                                            confirmButtonColor: "#3e9c76",
                                            confirmButtonText: "OK",
                                            closeOnConfirm: true,
                                            closeOnCancel: true,
                                            allowOutsideClick: true
                                        });
                                    }
                                } );
                            } else {
                                console.log('Cancel subscription deactivation');
                                swal ( {
                                    title: "Subscription haven't deactivated.",
                                    type: "error",
                                    confirmButtonColor: "#3e9c76",
                                    confirmButtonText: "OK",
                                    closeOnConfirm: true,
                                    closeOnCancel: true,
                                    allowOutsideClick: true
                                });
                            }
                        })
                })


            }
        });
    </script>

</div>
</body>
</html>
